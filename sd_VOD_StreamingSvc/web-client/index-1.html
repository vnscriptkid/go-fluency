<!DOCTYPE html>
<html>
<head>
    <title>HLS Player</title>
    <style>
        video {
            width: 100%;
        }
    </style>
</head>
<body>
    <video id="videoPlayer" controls autoplay></video>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        // HLS playlist URL
        const playlistURL = 'http://localhost:8080/playlist.m3u8';

        // HLS player initialization
        if (Hls.isSupported()) {
            const video = document.getElementById('videoPlayer');
            const hls = new Hls();
            hls.loadSource(playlistURL);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play();
            });

            // Adaptive streaming logic
            const availableBitrates = ['500k', '1000k', '2000k'];
            let currentBitrateIndex = 0;

            video.addEventListener('canplay', () => {
                const currentBitrate = availableBitrates[currentBitrateIndex];
                console.log('Current bitrate:', currentBitrate);

                const nextBitrateIndex = findNextBitrateIndex(video);
                if (nextBitrateIndex !== -1 && nextBitrateIndex !== currentBitrateIndex) {
                    const nextBitrate = availableBitrates[nextBitrateIndex];
                    console.log('Next bitrate:', nextBitrate);
                    switchBitrate(nextBitrateIndex);
                }
            });

            function findNextBitrateIndex(video) {
                const currentBitrate = video.videoWidth * video.videoHeight;
                let nextBitrateIndex = -1;

                for (let i = 0; i < availableBitrates.length; i++) {
                    const bitrate = availableBitrates[i];
                    const resolution = getResolutionFromBitrate(bitrate);
                    const resolutionBitrate = resolution.width * resolution.height;

                    if (resolutionBitrate > currentBitrate) {
                        nextBitrateIndex = i;
                        break;
                    }
                }

                return nextBitrateIndex;
            }

            function switchBitrate(bitrateIndex) {
                console.log('Switching bitrate...', bitrateIndex)
                currentBitrateIndex = bitrateIndex;
                const nextBitrate = availableBitrates[currentBitrateIndex];
                const nextURL = `http://localhost:8080/segment/${nextBitrate}/output_${nextBitrate}000.ts`;
                hls.nextLevel = bitrateIndex;
                hls.startLevel = bitrateIndex;
                hls.currentLevel = bitrateIndex;
                hls.loadSource(nextURL);
            }

            function getResolutionFromBitrate(bitrate) {
                switch (bitrate) {
                    case '500k':
                        return { width: 640, height: 360 };
                    case '1000k':
                        return { width: 1280, height: 720 };
                    case '2000k':
                        return { width: 1920, height: 1080 };
                    default:
                        return { width: 640, height: 360 };
                }
            }
        } else {
            console.error('HLS is not supported.');
        }
    </script>
    
</body>
</html>
